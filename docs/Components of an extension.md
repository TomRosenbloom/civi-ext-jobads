# Components of an extension

covered here: https://docs.civicrm.org/dev/en/latest/extensions/structure/

To get a better understanding of what these components are, let's put them in the order they are created, when creating a CRUD entity...

## The basic framework

`civix generate:module myextension` 

Creates:

- **info.xml**
- **myextension.php**
- **myextension.civix.php**
- **README.md**
- **LICENSE.txt**
- *build*
- *CRM/MyExtension*
- **images/screenshot.jpg**
- *templates*
- *xml*

Note that the folders created here are mostly empty (italics).

This could be a good time to update a few things in [info.xml](https://docs.civicrm.org/dev/en/latest/extensions/info-xml/) - name, description and author of the extension.



## The entity

`civix generate:entity MyEntity`

Updates:

- info.xml - adds entity-types 'mixin'

Creates:

- *api/v3*
- **Civi/Api4/Myentity.php**
- **CRM/Myentity/BAO/Myentity.php**
- *CRM/Myentity/DAO*
- **tests/phpunit/bootstrap.php**
- *tests/phpunit/api/v3*
- **xml/schema/CRM/Myentity/Myentity.entityType.php**
- **xml/schema/CRM/Myentity/Myentity.xml**

At this point it would be typical to make some manual changes to `xml/schema/CRM/Myentity/Myentity.xml`, which is the file that declares/defines the structure of your entity. This is for the most part a declaration of the structure and properties of the SQL table that will be used to store your entity items. So the root tag is 'table', and that contains tags like 'name' (the name the table will be given in SQL), a couple of 'field' tags, and tags defining primary keys, foreign keys. In the initial form generated by civix, there are just two field tags, one for the id of this entity and one for contact id. Also primary key, defined as the id, and foreign key, linking the contact id field to the civicrm_contact table (note the primaryKey and foreignKey tags are not nested but placed next to the fields they relate to). Of course these two 'starter' fields aren't of any great use on their own, and that's why you would normally add some new fields at this stage.

For **one-to-one** data, which will be stored in the same table, you add these as `<field>` tags, fully defined here in MyEntity.xml, but for **one-to-many** [and many-to-many?] the standard/default method is to first define an Option Group via the CiviCRM interface (under Administer->System Settings), then use the generated name of that option group in the field definition.

Example of one-to-one data definition:

```xml
  <field>
    <name>description</name>
    <title>Full description</title>
    <type>longtext</type>
    <comment>Full description</comment>
    <html>
      <type>RichTextEditor</type>
      <rows>8</rows>
      <cols>60</cols>
    </html>
  </field>
```

Example of one-to-many data definition:

```xml
  <field>
    <name>my_option_value</name>
    <title>My option value</title>
    <type>int unsigned</type>
    <required>true</required>
    <default>1</default>
    <comment>valid value, from my option group</comment>
    <pseudoconstant>
      <optionGroupName>my_option_group</optionGroupName>
    </pseudoconstant>
    <html>
      <type>Select</type>
      <label>My option</label>
    </html>
  </field>
```

[is there a way that avoids using option groups? That seems like a dependency, i.e. the extension will only work when those options groups are present. Presumably there is a way to package related tables within an extension - like this I guess (schema for `case` entity in core): https://github.com/civicrm/civicrm-core/tree/master/xml/schema/Case. CaseActivity.xml has foreign keys to Case and Activity tables

yes there is - after an option group is created via the UI, you can then export it via the API into mgd file in extension https://chat.civicrm.org/civicrm/pl/xd4ypkrzxbymfmtgyhcc33bd3e]





## The entity boilerplate

`civix generate:entity-boilerplate`

Creates:

- **CRM/Myentity/DAO/JobAd.php** - this is your extension's local implementation of CiviCRM's core data access object (DAO) class(es) https://docs.civicrm.org/dev/en/latest/framework/codebase/#dao
- **sql/auto_install.sql** - https://docs.civicrm.org/dev/en/latest/framework/codebase/#sql
- **sql/auto_uninstall.sql**

[NB Civix will report having written to myentity.civix.php but don't be misled - this file hasn't been changed, but has been re-written the same as before. Civix re-writes this file every time]

Civix will point out you don't have an upgrader class.



## The upgrader class

`civix generate:upgrader`

Updates:

- info.xml - adds `<upgrader>CRM_Myentity_Upgrader</upgrader>`

Creates:

- **CRM/Myentity/Upgrader.php**

https://docs.civicrm.org/dev/en/latest/step-by-step/create-entity/#5-add-upgrader-class

"We need an upgrader class so that upon installation and uninstallation of our extension the files `auto_install.sql` and `auto_unsinstall.sql` are executed."

Now everything is in place, and we can install the extension, with `cv en myentity`. Now if we check the extensions page we'll see that the extension is installed (it would have already been listed, but not installed). We'll also find that there is a table civicrm_myentity in our database, and that Myentity is available in the APIv4 UI. We can now use the API UI to `create` a record in the civicrm_myentity table, then `get`, `delete` etc.

 

[at this stage we can make a SK search for our entity, and note there will be update and delete paths available when we make a table display... ]

[add and update paths - these are (or can be) added manually to xml/schema/CRM/Myentity/MyEntity.xml, and then they appear in CRM/Myentity/DAO/MyEntity.php - but is that neccessary? I did that for jobads, but in 'foo' they have appeared automatically at some stage (?) And the delete path? I had trouble with that in JobAds, but it seems to have appeared automatically in the UI for foo, but is not defined in either of these files (!?)]



## Install the extension

`cv en myentity`



Now we should see the following effects in the UI:

- the new extension appears as 'Enabled' under Administration->Customise Data & Screens->Extensions [is this the normal location?]
- the entity can be found in Api Explorer
- you can use the Api Explorer to perform CRUD actions on the entity
  - when you Create and Update, you'll see the fields as you defined in myentity.xml




If we are creating a new entity, we've just followed the first iteration of a cycle:

1) update entity schema 
2) generate boilerplate 
3) generate upgrader
4) (re-)install

This cycle will be repeated for any subsequent changes to the entity schema.



What next? Whilst we can now perform CRUD actions through the API UI, that's not very user-friendly - only really suitable for advanced CiviCRM users. What we want now is to build into our extension some bespoke CRUD components suitable for non-technical users:

- searches and displays to view our entity data
- forms to create and update entity data

We might want different versions of these components for different users and different contexts:

- a search display a contact summary tab, showing data related to that contact only
- an admin front end
- public facing views

We might want to add some navigation links to appear in the Civi interface.

We will also want to ensure that our extension is properly self-contained and portable - all its components and dependencies are defined within the extension.

There's no particular order for doing those things in [?], but there are some basic principles.  

1. create, in UI
2. export
3. insert in code

In no particular order then:

## Define an option group

Create an option group via the UI.

Export with API UI [in Voscur I have to do this manually because it's an older version, but in latest Civi you can use civix export]

- get id or name of option group
- OptionGroup export id=1234, or name =option_group_name
- created `managed` folder
- create suitably named file `managed/my_option_group.mgd.php`







## Create a packaged search

## Create a submission form

## Create a navigation link





